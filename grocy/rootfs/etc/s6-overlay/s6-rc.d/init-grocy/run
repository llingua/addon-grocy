#!/command/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Home Assistant Community Add-on: Grocy (Node Edition)
# Prepares persistent storage for the refactored Node.js application
# ==============================================================================
set -euo pipefail

DATA_DIR="/data/grocy"
STATE_FILE="${DATA_DIR}/state.json"
DEFAULT_STATE="/opt/grocy/data/default-state.json"
EMPTY_STATE="/opt/grocy/data/empty-state.json"

bashio::log.info 'Preparing persistent storage for Grocy Node Edition'

if ! bashio::fs.directory_exists "${DATA_DIR}"; then
    bashio::log.notice 'Creating data directory'
    mkdir -p "${DATA_DIR}"
fi

if ! bashio::fs.file_exists "${STATE_FILE}"; then
    if bashio::config.false 'demo_data'; then
        bashio::log.notice 'Initializing with an empty dataset'
        cp "${EMPTY_STATE}" "${STATE_FILE}"
    else
        bashio::log.notice 'Seeding demo dataset'
        cp "${DEFAULT_STATE}" "${STATE_FILE}"
    fi
fi

if bashio::fs.file_exists "${STATE_FILE}"; then
    chmod 600 "${STATE_FILE}"
fi

touch "${DATA_DIR}/.keep"
chmod 600 "${DATA_DIR}/.keep"
